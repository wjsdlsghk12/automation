/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    // id 'buildlogic.java-application-conventions'
    id 'java'
    id 'application'
}

group 'org.example.app'
version '1.0'

repositories {
    maven {
    url 'https://repo.maven.apache.org/maven2'
        
    }
}

dependencies {
    // Appium
    implementation 'io.appium:java-client:8.4.0'
    testImplementation 'io.appium:java-client:8.4.0'

    // Cucumber
    implementation 'io.cucumber:cucumber-java:7.11.0'
    testImplementation 'io.cucumber:cucumber-java:7.11.0'

    // JUnit 5ì™€ í˜¸í™˜ë˜ëŠ” Cucumber í”ŒëŸ¬ê·¸ì¸ ì‚¬ìš©
    implementation 'io.cucumber:cucumber-junit-platform-engine:7.11.0'
    testImplementation 'io.cucumber:cucumber-junit-platform-engine:7.11.0'

    // Selenium
    implementation 'org.seleniumhq.selenium:selenium-java:4.12.0'

    // JUnit
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.7.0'
    testImplementation 'org.junit.jupiter:junit-jupiter-engine:5.7.0'
    
    // JUnit Platform Suite API ì˜ì¡´ì„± ì¶”ê°€
    testImplementation 'org.junit.platform:junit-platform-suite-api:1.9.2'  // Suite API ì˜ì¡´ì„± ì¶”ê°€

    // SLF4J API ì˜ì¡´ì„± (ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µë˜ëŠ” ê²ƒì¼ ìˆ˜ ìˆìŒ)
    implementation 'org.slf4j:slf4j-api:2.0.0-alpha1'

    // // Log4j ì˜ì¡´ì„± (SLF4J ë¡œê¹… êµ¬í˜„ì²´)
    // implementation 'org.apache.logging.log4j:log4j-slf4j-impl:2.20.0'
    // Log4j2 ì˜ì¡´ì„± ì¶”ê°€
    implementation 'org.apache.logging.log4j:log4j-api:2.17.2'
    implementation 'org.apache.logging.log4j:log4j-core:2.17.2'
    implementation 'org.apache.logging.log4j:log4j-slf4j-impl:2.17.2' // SLF4Jì™€ì˜ í˜¸í™˜ì„ ìœ„í•œ ì˜ì¡´
}

application {
    // Define the main class for the application.
    mainClass = 'org.example.app.App'
}

configurations {
    cucumberRuntime {
        extendsFrom testImplementation
    }
}

task cucumberCli(type: JavaExec, dependsOn: [assemble, testClasses]) {
    ignoreExitValue = true // í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•´ë„ ë¹Œë“œê°€ ì¤‘ë‹¨ë˜ì§€ ì•Šë„ë¡ ì„¤ì •
    main = "io.cucumber.core.cli.Main"
    classpath = configurations.cucumberRuntime + sourceSets.main.output + sourceSets.test.output
    jvmArgs('--add-opens', 'java.base/java.lang=ALL-UNNAMED')
    args = [
        '--plugin', 'pretty',
        '--plugin', 'html:target/cucumber-report.html',// Cucumber Reporting (html, xml) ì„¤ì • ì¶”ê°€
        '--plugin', 'junit:target/cucumber-junit-report.xml',
        '--plugin', 'json:target/cucumber-report.json',
        '--plugin', 'rerun:target/rerun.txt', // Test Scenario ì¤‘ì— ì‹¤íŒ¨í•œ Scnario ëª©ë¡ë§Œ íŒŒì¼ë¡œ ì¶œë ¥
        '--glue', 'org.example.app.steps',
        'src/test/resources'
    ]
    if (project.hasProperty('cucumberTags')) {
        args += ['--tags', project.getProperty("cucumberTags")]
    }
}

task sendSlackNotification {
    doLast {
        def webhookUrl = 'https://hooks.slack.com/services/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'  // ì—¬ê¸°ì— ì‹¤ì œ Webhook URLì„ ë„£ì–´ì•¼ í•¨
        def message = [
            text: "âœ… Cucumber í…ŒìŠ¤íŠ¸ ì™„ë£Œ!\n*ê²°ê³¼ íŒŒì¼:* <file://$projectDir/target/cucumber-report.html>"
        ]

        def connection = new URL(webhookUrl).openConnection()
        connection.setRequestMethod('POST')
        connection.setRequestProperty('Content-Type', 'application/json')
        connection.setDoOutput(true)

        def jsonPayload = new groovy.json.JsonBuilder(message).toString()
        connection.getOutputStream().write(jsonPayload.getBytes('UTF-8'))

        def responseCode = connection.getResponseCode()
        if (responseCode == 200) {
            println "âœ… Slack ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"
        } else {
            println "âŒ Slack ì•Œë¦¼ ì‹¤íŒ¨: $responseCode"
        }
    }
}





task cleanRerunFile {
    doLast {
        File rerunFile = file("target/rerun.txt")
        File cleanedFile = file("target/rerun-clean.txt")

        if (rerunFile.exists() && rerunFile.length() > 0) {
            println "ğŸ›  Cleaning rerun.txt..."
            
            // íŒŒì¼ ì½ê³  "file:" ë¶€ë¶„ ì œê±°
            def cleanedContent = rerunFile.text.replaceAll("file:", "").trim()
            cleanedFile.text = cleanedContent

            println "âœ… Cleaned rerun file: target/rerun-clean.txt"
        } else {
            println "âš ï¸ No failed tests found in rerun.txt. Skipping cleanup."
        }
    }
}


task rerunCucumber(type: JavaExec) {
    dependsOn cleanRerunFile // íŒŒì¼ ì •ë¦¬ ì‘ì—… í›„ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •

    main = "io.cucumber.core.cli.Main"
    classpath = configurations.cucumberRuntime + sourceSets.main.output + sourceSets.test.output
    jvmArgs('--add-opens', 'java.base/java.lang=ALL-UNNAMED')

    args = [
        '--plugin', 'pretty',
        '--plugin', 'html:target/cucumber-report-rerun.html',
        '--plugin', 'junit:target/cucumber-junit-report-rerun.xml',
        '--plugin', 'json:target/cucumber-report-rerun.json',
        '--glue', 'org.example.app.steps',
        '@target/rerun-clean.txt' // ìˆ˜ì •ëœ ê²½ë¡œ ì‚¬ìš©
    ]
}

task retryFailedTests {
    dependsOn cleanRerunFile
    doLast {
        int maxRetries = 2 // ìµœëŒ€ 3ë²ˆ ì¬ì‹œë„
        int attempt = 1

        while (attempt <= maxRetries) {
            println "ğŸ”„ [Retry Attempt: $attempt] ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ë‹¤ì‹œ ì‹¤í–‰ ì¤‘..."

            def gradlewCommand = file("${project.rootDir}/gradlew").absolutePath // ì ˆëŒ€ ê²½ë¡œë¡œ gradlew ì°¾ê¸°
            def gradlewBatCommand = file("${project.rootDir}/gradlew.bat").absolutePath

            def result
            if (System.getProperty("os.name").toLowerCase().contains("win")) {
                result = exec {
                    ignoreExitValue = true
                    commandLine gradlewBatCommand, 'rerunCucumber' // Windowsì—ì„œëŠ” gradlew.bat ì‹¤í–‰
                }
            } else {
                result = exec {
                    ignoreExitValue = true
                    commandLine 'sh', '-c', "$gradlewCommand rerunCucumber" // Mac/Linuxì—ì„œëŠ” gradlew ì‹¤í–‰
                }
            }
            println "eeeeeeeeeee $result"
            if (result.exitValue == 0) {
                println "âœ… [Attempt $attempt] ì¬ì‹œë„ ì„±ê³µ!"
                break
            } else {
                println "âŒ [Attempt $attempt] ì‹¤íŒ¨, ë‹¤ìŒ ì‹œë„..."
            }
            attempt++
        }
    }
}

cucumberCli.finalizedBy retryFailedTests

// retryFailedTests ì‹¤í–‰ í›„ Slack ì•Œë¦¼ì„ ë³´ë‚´ë„ë¡ ì„¤ì •
retryFailedTests.finalizedBy sendSlackNotification

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}